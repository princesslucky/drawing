<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Princess Drawing Pro</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6499334539226182" crossorigin="anonymous"></script>
    <style>
        :root { --sidebar-w: 260px; --toolbar-w: 70px; --ad-h: 100px; --dark: #2c3e50; --panel: #34495e; --accent: #e74c3c; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #555; font-family: sans-serif; }
        
        /* 1. ìƒë‹¨ ê´‘ê³  ì˜ì—­ */
        .ad-banner { height: var(--ad-h); background: #fff; display: flex; justify-content: center; align-items: center; border-bottom: 2px solid #000; z-index: 100; }
        
        /* ë ˆì´ì•„ì›ƒ */
        .main-wrapper { display: flex; height: calc(100vh - var(--ad-h)); }
        
        /* 2. ì™¼ìª½ íˆ´ë°” */
        .toolbar { width: var(--toolbar-w); background: var(--panel); display: flex; flex-direction: column; align-items: center; padding: 10px 0; gap: 12px; border-right: 1px solid #1a252f; }
        .tool-btn { width: 45px; height: 45px; border-radius: 8px; border: none; background: #ecf0f1; cursor: pointer; font-weight: bold; font-size: 12px; }
        .tool-btn.active { background: var(--accent); color: white; }
        
        /* 3. ì¤‘ì•™ ìº”ë²„ìŠ¤ */
        .canvas-container { flex: 1; overflow: auto; display: flex; justify-content: center; align-items: center; position: relative; padding: 40px; }
        .canvas-stack { position: relative; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.4); }
        canvas { position: absolute; top: 0; left: 0; outline: none; }
        #base-canvas { position: relative; z-index: 0; }

        /* 4. ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” */
        .sidebar { width: var(--sidebar-w); background: var(--panel); color: white; display: flex; flex-direction: column; padding: 15px; border-left: 1px solid #1a252f; }
        .layer-box { flex: 1; background: var(--dark); border-radius: 5px; margin-top: 10px; overflow-y: auto; padding: 5px; }
        .layer-item { display: flex; align-items: center; padding: 8px; margin-bottom: 5px; background: #3e5871; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .layer-item.active { border-color: var(--accent); }
        
        /* ì„¤ì • ëª¨ë‹¬ */
        #setup-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; justify-content: center; align-items: center; color: white; }
        .modal-card { background: var(--panel); padding: 30px; border-radius: 15px; text-align: center; }
        input[type="number"], select { padding: 8px; border-radius: 5px; border: none; margin: 10px 0; width: 100%; }
        
        button.primary { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.2s; }
        button.primary:hover { opacity: 0.8; }
    </style>
</head>
<body>

<div class="ad-banner">
    <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-6499334539226182"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

<div id="setup-modal">
    <div class="modal-card">
        <h2>ğŸ¨ ìº”ë²„ìŠ¤ ìƒì„±</h2>
        ê°€ë¡œ(px): <input type="number" id="inp-w" value="1000">
        ì„¸ë¡œ(px): <input type="number" id="inp-h" value="800">
        <button class="primary" onclick="startApp()">ì‹œì‘í•˜ê¸°</button>
    </div>
</div>

<div class="main-wrapper">
    <div class="toolbar">
        <button class="tool-btn active" onclick="setMode('draw', this)">íœ</button>
        <button class="tool-btn" onclick="setMode('erase', this)">ì§€ìš°ê°œ</button>
        <button class="tool-btn" onclick="setMode('rect', this)">ë„¤ëª¨</button>
        <button class="tool-btn" onclick="setMode('circle', this)">ì›</button>
        <hr style="width:80%">
        <input type="color" id="col-pick" value="#000000" style="width:45px; height:45px; border:none; cursor:pointer;">
        <span id="sz-label">5px</span>
        <input type="range" id="sz-range" min="1" max="100" value="5" style="width:50px;">
    </div>

    <div class="canvas-container">
        <div class="canvas-stack" id="stack">
            <canvas id="base-canvas"></canvas>
        </div>
    </div>

    <div class="sidebar">
        <h4>ë¸ŒëŸ¬ì‹œ ì¢…ë¥˜</h4>
        <select id="brush-type">
            <option value="pen">1. ê¸°ë³¸ ë°€ì°© íœ</option>
            <option value="pencil">2. ì„œê±± ì—°í•„</option>
            <option value="water">3. íˆ¬ëª… ìˆ˜ì±„í™”</option>
            <option value="air">4. ë¶€ë“œëŸ¬ìš´ ì—ì–´ë¸ŒëŸ¬ì‹œ</option>
            <option value="cali">5. ë‚©ì‘ ìº˜ë¦¬ê·¸ë¼í”¼</option>
            <option value="marker">6. ë§ˆì»¤ íœ</option>
            <option value="dot">7. ë„íŠ¸ í”½ì…€</option>
            <option value="neon">8. ê´‘ì„  ë„¤ì˜¨</option>
            <option value="oil">9. ê±°ì¹œ ìœ í™”</option>
            <option value="spray">10. ëª¨ë˜ ìŠ¤í”„ë ˆì´</option>
            <option value="chalk">11. ë¶„í•„ ëŠë‚Œ</option>
            <option value="star">12. ë°˜ì§ ë³„</option>
            <option value="heart">13. ë¿…ë¿… í•˜íŠ¸</option>
            <option value="cloud">14. ëª½ê¸€ êµ¬ë¦„</option>
            <option value="grass">15. ì‚ì£½ í’€</option>
            <option value="snow">16. í•˜ì–€ ëˆˆ</option>
            <option value="chain">17. ì—°ê²° ì²´ì¸</option>
            <option value="glitter">18. í™”ë ¤í•œ ê¸ˆê°€ë£¨</option>
        </select>
        <hr>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>ë ˆì´ì–´</span>
            <button onclick="addLayer()" style="cursor:pointer; padding:2px 8px;">+</button>
        </div>
        <div class="layer-box" id="layer-list"></div>
        
        <div style="display:flex; gap:5px; margin-top:10px;">
            <button class="primary" onclick="undo()" style="background: #95a5a6; font-size: 12px;">ë’¤ë¡œ ê°€ê¸° (Ctrl+Z)</button>
        </div>
        <button class="primary" style="margin-top:10px;" onclick="saveImg()">ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
</div>

<script>
    let layers = [];
    let curIdx = 0;
    let isDrawing = false;
    let mode = 'draw';
    let cw, ch;
    let undoStack = [];
    const MAX_UNDO = 20;

    function startApp() {
        cw = document.getElementById('inp-w').value;
        ch = document.getElementById('inp-h').value;
        const base = document.getElementById('base-canvas');
        base.width = cw; base.height = ch;
        document.getElementById('stack').style.width = cw + 'px';
        document.getElementById('stack').style.height = ch + 'px';
        document.getElementById('setup-modal').style.display = 'none';
        addLayer();
    }

    function addLayer() {
        const id = layers.length;
        const cvs = document.createElement('canvas');
        cvs.width = cw; cvs.height = ch;
        cvs.style.zIndex = id + 1;
        document.getElementById('stack').appendChild(cvs);
        
        const layerObj = { id, cvs, ctx: cvs.getContext('2d'), vis: true };
        layers.push(layerObj);
        curIdx = id;
        
        bindEvents(cvs);
        updateLayerUI();
    }

    function bindEvents(cvs) {
        cvs.onmousedown = (e) => {
            saveState(); // ê·¸ë¦¬ê¸° ì‹œì‘ ì „ ìƒíƒœ ì €ì¥
            isDrawing = true;
            const ctx = layers[curIdx].ctx;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        };
        cvs.onmousemove = (e) => {
            if(!isDrawing) return;
            draw(e);
        };
        cvs.onmouseup = () => { isDrawing = false; };
        cvs.onmouseleave = () => { isDrawing = false; };
    }

    function saveState() {
        if (undoStack.length >= MAX_UNDO) undoStack.shift();
        const state = layers.map(l => ({
            id: l.id,
            data: l.cvs.toDataURL()
        }));
        undoStack.push(state);
    }

    function undo() {
        if (undoStack.length === 0) return;
        const prevState = undoStack.pop();
        prevState.forEach(s => {
            const layer = layers.find(l => l.id === s.id);
            if (layer) {
                const img = new Image();
                img.onload = () => {
                    layer.ctx.clearRect(0, 0, cw, ch);
                    layer.ctx.drawImage(img, 0, 0);
                };
                img.src = s.data;
            }
        });
    }

    function draw(e) {
        const ctx = layers[curIdx].ctx;
        const color = document.getElementById('col-pick').value;
        const size = document.getElementById('sz-range').value;
        const type = document.getElementById('brush-type').value;

        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = size;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.globalCompositeOperation = (mode === 'erase') ? 'destination-out' : 'source-over';

        if(type === 'pen') { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }
        else if(type === 'pencil') { ctx.globalAlpha = 0.5; ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); ctx.globalAlpha = 1; }
        else if(type === 'air') {
            let g = ctx.createRadialGradient(e.offsetX, e.offsetY, 0, e.offsetX, e.offsetY, size);
            g.addColorStop(0, color); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.fillRect(e.offsetX-size, e.offsetY-size, size*2, size*2);
        }
        else if(type === 'neon') { ctx.shadowBlur = size; ctx.shadowColor = color; ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); ctx.shadowBlur = 0; }
        else if(type === 'star') { if(Math.random()>0.9) { ctx.font=size+"px serif"; ctx.fillText("â˜…", e.offsetX, e.offsetY); } }
        else if(type === 'heart') { if(Math.random()>0.9) { ctx.font=size+"px serif"; ctx.fillText("â¤", e.offsetX, e.offsetY); } }
        else if(type === 'dot') { ctx.fillRect(Math.floor(e.offsetX/size)*size, Math.floor(e.offsetY/size)*size, size, size); }
        else { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }
    }

    function updateLayerUI() {
        const list = document.getElementById('layer-list');
        list.innerHTML = '';
        layers.slice().reverse().forEach(l => {
            const div = document.createElement('div');
            div.className = `layer-item ${l.id === curIdx ? 'active' : ''}`;
            div.innerHTML = `ë ˆì´ì–´ ${l.id} <span style="margin-left:auto; cursor:pointer;" onclick="toggleVis(${l.id}, event)">${l.vis ? 'ğŸ‘ï¸' : 'ğŸ•¶ï¸'}</span>`;
            div.onclick = () => { curIdx = l.id; updateLayerUI(); };
            list.appendChild(div);
        });
    }

    function toggleVis(id, event) {
        event.stopPropagation();
        const layer = layers.find(l => l.id === id);
        layer.vis = !layer.vis;
        layer.cvs.style.display = layer.vis ? 'block' : 'none';
        updateLayerUI();
    }

    function setMode(m, btn) { 
        mode = m; 
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function saveImg() {
        const out = document.createElement('canvas');
        out.width = cw; out.height = ch;
        const octx = out.getContext('2d');
        octx.fillStyle = "white"; octx.fillRect(0,0,cw,ch);
        layers.forEach(l => { if(l.vis) octx.drawImage(l.cvs, 0, 0); });
        const a = document.createElement('a');
        a.download = 'princess_art.png';
        a.href = out.toDataURL();
        a.click();
    }

    window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'z') { undo(); }
    });

    document.getElementById('sz-range').oninput = (e) => { document.getElementById('sz-label').innerText = e.target.value + 'px'; };
</script>

</body>
</html>